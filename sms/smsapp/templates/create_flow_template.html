
{% extends 'base.html' %}


{% block head %}
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  :root {
    --primary: #6366f1;
    --primary-hover: #4f46e5;
    --secondary: #8b5cf6;
    --accent: #06b6d4;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --dark: #1f2937;
    --light: #f8fafc;
    --gray-100: #f1f5f9;
    --gray-200: #e2e8f0;
    --gray-300: #cbd5e1;
    --gray-400: #94a3b8;
    --gray-500: #64748b;
    --gray-600: #475569;
    --gray-700: #334155;
    --gray-800: #1e293b;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    --gradient: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    --gradient-subtle: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
  }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    min-height: 100vh;
    color: var(--dark);
    line-height: 1.6;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
  }

  .header {
    text-align: center;
    margin-bottom: 3rem;
    animation: fadeInDown 1s ease-out;
  }

  .header h1 {
    font-size: 3rem;
    font-weight: 800;
    background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 1rem;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .header p {
    color: rgba(255, 255, 255, 0.9);
    font-size: 1.2rem;
    font-weight: 300;
  }

  .screens-section {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 1rem;
    border: 1px solid #000;
    animation: fadeInUp 1s ease-out 0.1s both;
  }

  .screens-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  .screens-header h3 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--gray-800);
  }

  .screen-tabs {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .screen-tab {
    background: var(--gray-100);
    border: 2px solid var(--gray-200);
    border-radius: 12px;
    padding: 0.3rem 0.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    color: var(--gray-700);
  }

  .screen-tab:hover {
    background: var(--gray-200);
    transform: translateY(-2px);
  }

  .screen-tab.active {
    background: var(--gradient);
    color: white;
    border-color: var(--primary);
  }

  .delete-screen {
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 0.2rem;
    border-radius: 4px;
    transition: background 0.2s;
  }

  .delete-screen:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .title-section {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 10px;
    padding: 2rem;
    margin-bottom: 1rem;
    border: 1px solid #000;
    animation: fadeInUp 1s ease-out 0.2s both;
  }

  .title-input-group {
    position: relative;
  }

  .title-input-group input {
    width: 100%;
    padding: 1rem 1.5rem;
    font-size: 1.1rem;
    border: 2px solid var(--gray-200);
    border-radius: 12px;
    background: white;
    transition: all 0.3s ease;
    font-weight: 500;
  }

  .title-input-group input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    transform: translateY(-2px);
  }

  .title-input-group label {
    position: absolute;
    top: -12px;
    left: 16px;
    background: white;
    padding: 0 8px;
    font-weight: 600;
    color: var(--gray-600);
    font-size: 0.9rem;
  }

  .add-content-section {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 1rem;
    border: 1px solid #000;
    animation: fadeInUp 1s ease-out 0.4s both;
  }

  .add-content-form {
    display: flex;
    gap: 1rem;
    align-items: end;
    flex-wrap: wrap;
  }

  .select-group {
    flex: 1;
    min-width: 250px;
  }

  .select-group label {
    display: block;
    font-weight: 600;
    color: var(--gray-700);
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .select-group select {
    width: 100%;
    padding: 0.5rem;
    border: 2px solid var(--gray-200);
    border-radius: 12px;
    background: white;
    font-size: 1rem;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .select-group select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  .btn {
    border: none;
    font-weight: 600;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    position: relative;
    overflow: hidden;
  }

  .btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
  }

  .btn:hover::before {
    left: 100%;
  }

  .btn-primary {
    background: var(--gradient);
    color: white;
    box-shadow: var(--shadow);
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
  }

  .btn-danger {
    background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
    color: white;
    font-size: 0.8rem;
  }

  .btn-success {
    background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
    color: white;
    padding: 0.5rem 1rem;
    font-size: 0.8rem;
  }

  .btn-secondary {
    background: var(--gray-100);
    color: var(--gray-700);
    border: 2px solid var(--gray-200);
  }

  .btn-secondary:hover {
    background: var(--gray-200);
    transform: translateY(-1px);
  }

  #builder {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-bottom: 1rem;
  }

  @media (max-width: 1024px) {
    #builder {
      grid-template-columns: 1fr;
    }
  }

  .panel {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 10px;
    padding: 2rem;
    border: 1px solid #000;
    animation: fadeInUp 1s ease-out 0.6s both;
  }

  .panel h3 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--gray-800);
    margin-bottom: 1.5rem;
    position: relative;
    padding-bottom: 0.5rem;
  }

  .panel h3::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 60px;
    height: 3px;
    background: var(--gradient);
    border-radius: 2px;
  }

  .content-item {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: var(--shadow);
    border: 1px solid var(--gray-200);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .content-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: var(--gradient);
  }

  .content-item:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
  }

  .content-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .content-type-badge {
    background: var(--gradient);
    color: white;
    padding: 0.3rem 0.8rem;
    border-radius: 10px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    font-weight: 600;
    color: var(--gray-700);
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
  }

  .form-control {
    width: 100%;
    padding: 0.8rem;
    border: 2px solid var(--gray-200);
    border-radius: 8px;
    font-size: 0.9rem;
    transition: all 0.3s ease;
  }

  .form-control:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  .checkbox-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 1rem 0;
  }

  .checkbox-group input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: var(--primary);
  }

  .options-container {
    background: var(--gray-50);
    border-radius: 12px;
    padding: 1rem;
    margin-top: 1rem;
  }

  .option-item {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    align-items: center;
  }

  .option-item input {
    flex: 1;
  }

  .preview-content {
    min-height: 400px;
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    border: 2px dashed var(--gray-200);
    transition: all 0.3s ease;
  }

  .preview-content:hover {
    border-color: var(--primary);
  }

  .empty-preview {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 300px;
    color: var(--gray-400);
    text-align: center;
  }

  .json-section {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 10px;
    padding: 2rem;
    border: 1px solid #000;
    animation: fadeInUp 1s ease-out 0.8s both;
  }

  .json-output {
    background: var(--gray-900);

    padding: 1.5rem;
    border-radius: 12px;
    font-family: 'Fira Code', 'Monaco', monospace;
    font-size: 0.9rem;
    line-height: 1.6;
    max-height: 400px;
    overflow-y: auto;
    white-space: pre-wrap;
    border: 1px solid var(--gray-700);
    margin-bottom: 1rem;
  }

  .json-output::-webkit-scrollbar {
    width: 8px;
  }

  .json-output::-webkit-scrollbar-track {
    background: var(--gray-800);
    border-radius: 4px;
  }

  .json-output::-webkit-scrollbar-thumb {
    background: var(--gray-600);
    border-radius: 4px;
  }

  .json-output::-webkit-scrollbar-thumb:hover {
    background: var(--gray-500);
  }

  /* Preview Form Styles */
  .preview-content h1 {
    font-size: 2rem;
    font-weight: 700;
    color: var(--gray-800);
    margin: 1rem 0;
  }

  .preview-content h3 {
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--gray-700);
    margin: 0.8rem 0;
  }

  .preview-content p {
    color: var(--gray-600);
    margin: 0.5rem 0;
  }

  .preview-content small {
    color: var(--gray-500);
    font-size: 0.8rem;
  }

  .preview-form-group {
    margin-bottom: 1.5rem;
  }

  .preview-form-group label {
    display: block;
    font-weight: 600;
    color: var(--gray-700);
    margin-bottom: 0.5rem;
  }

  .preview-form-group input,
  .preview-form-group textarea,
  .preview-form-group select {
    width: 100%;
    padding: 0.8rem;
    border: 2px solid var(--gray-200);
    border-radius: 8px;
    font-size: 1rem;
    background: var(--gray-50);
  }

  .preview-form-group fieldset {
    border: 2px solid var(--gray-200);
    border-radius: 8px;
    padding: 1rem;
    background: var(--gray-50);
  }

  .preview-form-group legend {
    font-weight: 600;
    color: var(--gray-700);
    padding: 0 0.5rem;
  }

  .radio-group label,
  .checkbox-group-preview label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: normal;
    margin-bottom: 0.5rem;
    cursor: pointer;
  }

  /* Animations */
  @keyframes fadeInDown {
    from {
      opacity: 0;
      transform: translateY(-30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateX(-20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .content-item {
    animation: slideIn 0.3s ease-out;
  }

  /* Floating particles background effect */
  .bg-particles {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: -1;
  }

  .particle {
    position: absolute;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    animation: float 6s ease-in-out infinite;
  }

  .particle:nth-child(1) { width: 80px; height: 80px; left: 10%; animation-delay: 0s; }
  .particle:nth-child(2) { width: 60px; height: 60px; left: 20%; animation-delay: 1s; }
  .particle:nth-child(3) { width: 120px; height: 120px; left: 60%; animation-delay: 2s; }
  .particle:nth-child(4) { width: 40px; height: 40px; left: 80%; animation-delay: 3s; }
  .particle:nth-child(5) { width: 100px; height: 100px; left: 40%; animation-delay: 4s; }

  @keyframes float {
    0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.1; }
    50% { transform: translateY(-100px) rotate(180deg); opacity: 0.3; }
  }

  /* Responsive Design */
  @media (max-width: 768px) {

    .header h1 {
      font-size: 2rem;
    }

    .add-content-form {
      flex-direction: column;
    }

    .select-group {
      min-width: auto;
    }
  }
</style>
{% endblock %}

{% block content %}

<div class="container mt-4">
    <h1 class="m-2 mt-3" style="font-size: 20px;">Step 1: Create Flow</h1>
    <div>
        <form method="POST" action="{% url 'create_flow_message' %}" style="border: 1px solid #cdcdcd; border-radius: 5px; margin-bottom: 5px;">
            {% csrf_token %}
    
            <div class="d-grid">
                <div class="d-flex">
                    <div class="form-group w-100 m-2 input_background">
                        <label for="name" class="form-label mt-2">Flow Name:</label>
                        <input type="text" id="name" name="name" class="form-control" placeholder="Enter Flow Title" required>
                    </div>
                
                    <div class="form-group w-100 m-2 input_background">
                        <label for="category" class="form-label mt-2">Category:</label>
                        <select name="category" id="category" class="form-select w-100" required>
                            <option selected>Select Category</option>
                            <option value="Utility">UTILITY</option>
                            <option value="APPOINTMENT_BOOKING">APPOINTMENT BOOKING</option>
                            <option value="LEAD_GENERATION">LEAD GENERATION</option>
                            <option value="CONTACT_US">CONTACT US</option>
                            <option value="CUSTOMER_SUPPORT">CUSTOMER SUPPORT</option>
                            <option value="SURVEY">SURVEY</option>
                            <option value="OTHER">OTHER</option>
                            <option value="MARKETING">MARKETING</option>
                            <option value="SIGN_UP">SIGN UP</option>
                            <option value="SIGN_IN">SIGN IN</option>
                        </select>
                    </div>
                </div>
            
                <div class="form-group m-2 input_background">
                    <label for="json_flow" class="form-label mt-2">JSON Flow:</label>
                    <textarea id="jsonOutput" name="json_flow" class="form-control" rows="4" placeholder="Create a flow using the FlowBuilder and then paste the generated JSON for the flow." required></textarea>
                </div>
            </div>
        
            <center><button type="submit" class="btn btn-primary mb-2">Submit</button></center>
        </form>  
        
        <div>
            {% if error_message %}
                <div class="alert alert-danger">
                    {{ error_message }}
                </div>
            {% endif %}
        </div>
    
        <div class="modal fade" id="moveToTemplatesModal" tabindex="-1" aria-labelledby="moveToTemplatesModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content" style="min-width: 500px;">
                    <div class="modal-header">
                        <h5 class="modal-title" id="moveToTemplatesModalLabel">Create Template from Flow</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="createTemplateForm">
                            <input type="hidden" name="flow_id" id="flow_id">
                            <div class="mb-3">
                                <label for="template_name" class="form-label">Template Name</label>
                                <input type="text" class="form-control" id="template_name" name="template_name" required>
                            </div>
                            <div class="mb-3">
                                <label for="category" class="form-label">Category</label>
                                <select class="form-select" id="category" name="category" required>
                                    <option value="">Select a category</option>
                                    <option value="MARKETING">MARKETING</option>
                                    <option value="UTILITY">UTILITY</option>
                                    <option value="AUTHENTICATION">AUTHENTICATION</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="lang" class="form-label mt-2">Language:</label>
                                <select name="lang" id="lang" class="form-control" required>
                                    <option selected>Select Language</option>
                                    <option value="af">Afrikaans</option>
                                    <option value="sq">Albanian</option>
                                    <option value="ar">Arabic</option>
                                    <option value="az">Azerbaijani</option>
                                    <option value="bn">Bengali</option>
                                    <option value="bg">Bulgarian</option>
                                    <option value="ca">Catalan</option>
                                    <option value="zh_CN">Chinese (CHN)</option>
                                    <option value="zh_HK">Chinese (HKG)</option>
                                    <option value="zh_TW">Chinese (TAI)</option>
                                    <option value="hr">Croatian</option>
                                    <option value="cs">Czech</option>
                                    <option value="da">Danish</option>
                                    <option value="nl">Dutch</option>
                                    <option value="en">English</option>
                                    <option value="en_GB">English (UK)</option>
                                    <option value="en_US">English (US)</option>
                                    <option value="et">Estonian</option>
                                    <option value="fil">Filipino</option>
                                    <option value="fi">Finnish</option>
                                    <option value="fr">French</option>
                                    <option value="ka">Georgian</option>
                                    <option value="de">German</option>
                                    <option value="el">Greek</option>
                                    <option value="gu">Gujarati</option>
                                    <option value="ha">Hausa</option>
                                    <option value="he">Hebrew</option>
                                    <option value="hi">Hindi</option>
                                    <option value="hu">Hungarian</option>
                                    <option value="id">Indonesian</option>
                                    <option value="ga">Irish</option>
                                    <option value="it">Italian</option>
                                    <option value="ja">Japanese</option>
                                    <option value="kn">Kannada</option>
                                    <option value="kk">Kazakh</option>
                                    <option value="rw_RW">Kinyarwanda</option>
                                    <option value="ko">Korean</option>
                                    <option value="ky_KG">Kyrgyz (Kyrgyzstan)</option>
                                    <option value="lo">Lao</option>
                                    <option value="lv">Latvian</option>
                                    <option value="lt">Lithuanian</option>
                                    <option value="mk">Macedonian</option>
                                    <option value="ms">Malay</option>
                                    <option value="ml">Malayalam</option>
                                    <option value="mr">Marathi</option>
                                    <option value="nb">Norwegian</option>
                                    <option value="fa">Persian</option>
                                    <option value="pl">Polish</option>
                                    <option value="pt_BR">Portuguese (BR)</option>
                                    <option value="pt_PT">Portuguese (POR)</option>
                                    <option value="pa">Punjabi</option>
                                    <option value="ro">Romanian</option>
                                    <option value="ru">Russian</option>
                                    <option value="sr">Serbian</option>
                                    <option value="sk">Slovak</option>
                                    <option value="sl">Slovenian</option>
                                    <option value="es">Spanish</option>
                                    <option value="es_AR">Spanish (ARG)</option>
                                    <option value="es_ES">Spanish (SPA)</option>
                                    <option value="es_MX">Spanish (MEX)</option>
                                    <option value="sw">Swahili</option>
                                    <option value="sv">Swedish</option>
                                    <option value="ta">Tamil</option>
                                    <option value="te">Telugu</option>
                                    <option value="th">Thai</option>
                                    <option value="tr">Turkish</option>
                                    <option value="uk">Ukrainian</option>
                                    <option value="ur">Urdu</option>
                                    <option value="uz">Uzbek</option>
                                    <option value="vi">Vietnamese</option>
                                    <option value="zu">Zulu</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="body_text" class="form-label">Body Text</label>
                                <textarea class="form-control" id="body_text" name="body_text" rows="3" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="flow_button" class="form-label">Button Name:</label>
                                <input type="text" class="form-control" id="flow_button" name="flow_button" required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary" form="createTemplateForm">Create Template</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% if messages %}
        {% for message in messages %}
            {% if message.tags == 'success' %}
                <div class="alert alert-success">{{ message }}</div>
            {% elif message.tags == 'error' %}
                <div class="alert alert-danger">{{ message }}</div>
            {% elif message.tags == 'warning' %}
                <div class="alert alert-warning">{{ message }}</div>
            {% endif %}
        {% endfor %}
    {% endif %}
    <h1 class="m-2 mt-3" style="font-size: 20px;">Flow Builder</h1>

    <div>
        <div class="bg-particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        </div>

        <div class="container p-0">

        <div class="screens-section">
            <div class="screens-header">
            <h4>üì± Screens</h4>
            <button type="button" class="btn btn-primary" onclick="addScreen()">
                ‚ûï Add Screen
            </button>
            </div>
            <div class="screen-tabs" id="screenTabs">
            <!-- Screen tabs will be added here -->
            </div>
        </div>

        <div class="d-flex">
            <div class="title-section w-50 me-3">
                <div class="title-input-group">
                <label>Screen Title</label>
                <input type="text" id="titleInput" placeholder="Enter your screen title..." />
                </div>
            </div>

            <div class="add-content-section w-100">
                <div class="add-content-form">
                <div class="select-group">
                    <label>Add Content Type</label>
                    <select id="addContentSelect">
                    <option value="">Choose a content type...</option>
                    <optgroup label="üìù Text Elements">
                        <option value="TextHeading">Large Heading</option>
                        <option value="TextSubheading">Small Heading</option>
                        <option value="TextBody">Body Message</option>
                        <option value="TextCaption">Caption</option>
                    </optgroup>
                    <optgroup label="‚úèÔ∏è Input Fields">
                        <option value="TextInput">Short Answer</option>
                        <option value="TextArea">Paragraph</option>
                        <option value="DatePicker">Date Picker</option>
                    </optgroup>
                    <optgroup label="‚òëÔ∏è Selection Options">
                        <option value="single-choice">Single Choice</option>
                        <option value="multiple-choice">Multiple Choice</option>
                        <option value="dropdown">Dropdown</option>
                        <option value="optin">Opt In Checkbox</option>
                    </optgroup>
                    </select>
                </div>
                <button type="button" class="btn btn-primary" onclick="addContent()">
                    ‚ú® Add Content
                </button>
                </div>
            </div>
        </div>

        <div id="builder">
            <div class="panel">
            <h4>üìã Content Editor</h4>
            <div id="contentList">
                <!-- Content blocks will be added here -->
            </div>
            </div>
            
            <div class="panel">
            <h4>üëÅÔ∏è Live Preview</h4>
            <div class="preview-content" id="previewContent">
                <div class="empty-preview">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
                <h3>Your form will appear here</h3>
                <p>Add content elements to see a live preview</p>
                </div>
            </div>
            </div>
        </div>

        <!-- <div class="json-section">
            <h3>üîß JSON Output</h3>
            <div class="json-output" id="jsonOutput">{}</div>
            <button type="button" class="btn btn-secondary" onclick="copyJSON()">
            üìã Copy JSON
            </button>
        </div> -->
        </div>
    </div>

    {% if flows %}
    <h1 class="m-2 mt-3" style="font-size: 20px;">Step 2: Publish and then move flow to templates</h1>
        <div class="table-responsive" style="max-height: 400px;scrollbar-width: thin;">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Categories</th>
                        <th>ID</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for flow in flows %}
                        <tr>
                            <td>{{ flow.name }}</td>
                            <td>
                                <span class="badge {% if flow.status == 'DRAFT' %}bg-warning {% elif flow.status == 'DEPRECATED' %}bg-secondary {% else %}bg-success{% endif %}">
                                    {{ flow.status }}
                                </span>
                            </td>
                            <td>
                                {% if flow.categories %}
                                    {{ flow.categories|join:", " }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ flow.id }}</td>
                            <td>
                                {% if flow.status == 'DRAFT' %}
                                    <button class="btn btn-success btn-sm publish-btn" 
                                            data-flow-id="{{ flow.id }}"
                                            data-flow-name="{{ flow.name }}">
                                        <i class='bx bxs-cloud-upload h6 text-white m-0' ></i>
                                        Publish
                                    </button>
                                {% endif %}
                                <button class="btn btn-danger btn-sm delete-btn" 
                                        data-flow-id="{{ flow.id }}"
                                        data-flow-name="{{ flow.name }}">
                                    <i class='bx bxs-trash h6 text-white m-0'></i>
                                    Delete
                                </button>
                                <button class="btn btn-primary btn-sm preview-btn" 
                                        data-flow-id="{{ flow.id }}"
                                        data-flow-name="{{ flow.name }}">
                                    <i class='bx bxs-show h6 text-white m-0'></i>
                                    Preview
                                </button>
                                {% if flow.status == 'PUBLISHED' %}
                                <button class="btn btn-secondary btn-sm move-to-templates-btn mt-1"
                                        data-flow-id="{{ flow.id }}"
                                        data-flow-name="{{ flow.name }}">
                                    <i class='bx bx-send h6 text-white m-0'></i>
                                    Move to templates
                                </button>
                                <button class="btn btn-warning btn-sm deprecate-btn" 
                                        data-flow-id="{{ flow.id }}"
                                        data-flow-name="{{ flow.name }}">
                                    <i class='bx bx-block h6 text-white m-0'></i>
                                    Deprecate
                                </button>
                                {% endif %}
                            </td>                                
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="alert alert-info">
            No flows found.
        </div>
    {% endif %}
    
</div>

<script>
let screens = [{
  id: 'screen_0',
  title: 'Screen 1',
  contentItems: []
}];
let currentScreenIndex = 0;
let uniqueIdCounter = 1;

function generateId() {
  return 'content_' + (uniqueIdCounter++);
}

function addScreen() {
  const newScreen = {
    id: `screen_${screens.length}`,
    title: `Screen ${screens.length + 1}`,
    contentItems: []
  };
  screens.push(newScreen);
  currentScreenIndex = screens.length - 1;
  renderScreenTabs();
  switchToScreen(currentScreenIndex);
}

function deleteScreen(index) {
  if (screens.length <= 1) {
    alert('Cannot delete the last screen');
    return;
  }
  screens.splice(index, 1);
  if (currentScreenIndex >= screens.length) {
    currentScreenIndex = screens.length - 1;
  }
  renderScreenTabs();
  switchToScreen(currentScreenIndex);
}

function switchToScreen(index) {
  currentScreenIndex = index;
  const screen = screens[currentScreenIndex];
  document.getElementById('titleInput').value = screen.title;
  renderScreenTabs();
  renderContentList();
  updatePreview();
  updateJSON();
}

function renderScreenTabs() {
  const container = document.getElementById('screenTabs');
  container.innerHTML = '';
  
  screens.forEach((screen, index) => {
    const tab = document.createElement('div');
    tab.className = `screen-tab ${index === currentScreenIndex ? 'active' : ''}`;
    tab.innerHTML = `
      <span>${screen.title}</span>
      ${screens.length > 1 ? `<button class="delete-screen" onclick="deleteScreen(${index})">‚ùå</button>` : ''}
    `;
    tab.onclick = (e) => {
      if (!e.target.classList.contains('delete-screen')) {
        switchToScreen(index);
      }
    };
    container.appendChild(tab);
  });
}

function getCurrentScreen() {
  return screens[currentScreenIndex];
}

function addContent() {
  const select = document.getElementById('addContentSelect');
  const type = select.value;
  if (!type) return alert('Please select a content type.');

  let newItem = {
    id: generateId(),
    type,
    label: '',
    name: '',
    text: '',
    options: [],
    required: false,
    inputType: 'text',
    selectionType: '',
  };

  // Setup defaults for each type
  if (type.startsWith('Text')) {
    if (type === 'TextHeading') {
      newItem.text = 'Main Heading Text';
    } else if (type === 'TextSubheading') {
      newItem.text = 'Subheading Text';
    } else if (type === 'TextBody') {
      newItem.text = 'Body paragraph text content goes here. This is where you can add detailed information or instructions.';
    } else if (type === 'TextCaption') {
      newItem.text = 'Caption or small text content';
    } else {
      newItem.text = `Sample ${type}`;
    }
  } else if (type === 'TextInput') {
    newItem.label = 'Text Input Field';
    newItem.name = 'text_input';
    newItem.inputType = 'text';
  } else if (type === 'TextArea') {
    newItem.label = 'Text Area Field';
    newItem.name = 'text_area';
  } else if (type === 'DatePicker') {
    newItem.label = 'Date Selection';
    newItem.name = 'date_picker';
  } else if (['single-choice', 'multiple-choice', 'dropdown', 'optin'].includes(type)) {
    if (type === 'single-choice') {
      newItem.label = 'Single Choice Selection';
      newItem.name = 'single_choice';
    } else if (type === 'multiple-choice') {
      newItem.label = 'Multiple Choice Selection';
      newItem.name = 'multiple_choice';
    } else if (type === 'dropdown') {
      newItem.label = 'Dropdown Selection';
      newItem.name = 'dropdown';
    } else if (type === 'optin') {
      newItem.label = 'Opt-in Checkbox';
      newItem.name = 'optin';
    }
    
    newItem.selectionType = type;
    if (type === 'optin') {
      newItem.options = [];
    } else {
      newItem.options = ['Option 1', 'Option 2'];
    }
  }

  getCurrentScreen().contentItems.push(newItem);
  renderContentList();
  updatePreview();
  updateJSON();
  select.value = '';
}

function renderContentList() {
  const container = document.getElementById('contentList');
  container.innerHTML = '';
  
  const contentItems = getCurrentScreen().contentItems;
  
  if (contentItems.length === 0) {
    container.innerHTML = `
      <div class="empty-preview">
        <div style="font-size: 2rem; margin-bottom: 1rem;">üîß</div>
        <p>No content elements yet</p>
        <p style="font-size: 0.9rem; color: var(--gray-500);">Add some content to get started</p>
      </div>
    `;
    return;
  }
  
  for (const item of contentItems) {
    container.appendChild(renderContentItem(item));
  }
}

function getFieldTypeLabel(type) {
 
  const labels = {
    'TextHeading': 'Text Heading',
    'TextSubheading': 'Text Subheading',
    'TextBody': 'Text Body',
    'TextCaption': 'Text Caption',
    'TextInput': 'Text Input',
    'TextArea': 'Text Area',
    'DatePicker': 'Date Picker',
    'single-choice': 'Single Choice',
    'multiple-choice': 'Multiple Choice',
    'dropdown': 'Dropdown',
    'optin': 'Opt-in Checkbox'
  };
  return labels[type] || type;
}


function renderContentItem(item) {
  const div = document.createElement('div');
  div.className = 'content-item';
  div.id = item.id;

  // Header and delete
  const header = document.createElement('div');
  header.className = 'content-header';

  const badge = document.createElement('div');
  badge.className = 'content-type-badge';
  badge.textContent = getFieldTypeLabel(item.type);
  header.appendChild(badge);

  const delBtn = document.createElement('button');
  delBtn.textContent = 'üóëÔ∏è Delete';
  delBtn.className = 'btn btn-danger';
  delBtn.onclick = () => {
    const currentScreen = getCurrentScreen();
    currentScreen.contentItems = currentScreen.contentItems.filter(ci => ci.id !== item.id);
    renderContentList();
    updatePreview();
    updateJSON();
  };
  header.appendChild(delBtn);
  div.appendChild(header);

  // ‚úÖ Check TextInput first
  if (item.type === 'TextInput') {
    div.appendChild(createFormGroup('Field Label:', item.label, val => {
      item.label = val;
      item.name = toName(val);
      updatePreview();
      updateJSON();
    }));

    const helperDiv = document.createElement('div');
    helperDiv.style.cssText = 'font-size: 0.85rem; color: #666; margin-top: -0.5rem; margin-bottom: 1rem; font-style: italic;';
    helperDiv.textContent = 'Label that appears above the input field';
    div.appendChild(helperDiv);

    const inputTypeSelect = createSelectGroup('Input Type:', ['text', 'email', 'number', 'tel', 'url', 'password'], item.inputType, val => {
      item.inputType = val;
      updatePreview();
      updateJSON();
    });
    div.appendChild(inputTypeSelect);

    div.appendChild(createCheckboxGroup('Required Field:', item.required, val => {
      item.required = val;
      updatePreview();
      updateJSON();
    }));

  // ‚úÖ Check TextArea next
  } else if (item.type === 'TextArea') {
    div.appendChild(createFormGroup('Field Label:', item.label, val => {
      item.label = val;
      item.name = toName(val);
      updatePreview();
      updateJSON();
    }));

    const helperDiv = document.createElement('div');
    helperDiv.style.cssText = 'font-size: 0.85rem; color: #666; margin-top: -0.5rem; margin-bottom: 1rem; font-style: italic;';
    helperDiv.textContent = 'Label that appears above the text area';
    div.appendChild(helperDiv);

    div.appendChild(createCheckboxGroup('Required Field:', item.required, val => {
      item.required = val;
      updatePreview();
      updateJSON();
    }));

  // ‚úÖ Then check TextHeading / TextBody / etc
  } else if (item.type.startsWith('Text')) {
    const group = createFormGroup('Text Content:', item.text, val => {
      item.text = val;
      updatePreview();
      updateJSON();
    });

    const helperText = document.createElement('div');
    helperText.className = 'helper-text';
    helperText.style.cssText = 'font-size: 0.85rem; color: #666; margin-top: 0.25rem; font-style: italic;';
    
    switch(item.type) {
      case 'TextHeading':
        helperText.textContent = 'Main heading for the screen (large, bold text)';
        break;
      case 'TextSubheading':
        helperText.textContent = 'Secondary heading or section title';
        break;
      case 'TextBody':
        helperText.textContent = 'Regular paragraph text for descriptions or instructions';
        break;
      case 'TextCaption':
        helperText.textContent = 'Small text for captions, notes, or disclaimers';
        break;
    }

    group.appendChild(helperText);
    div.appendChild(group);

  // ‚úÖ Then check DatePicker
  } else if (item.type === 'DatePicker') {
    div.appendChild(createFormGroup('Field Label:', item.label, val => {
    

      item.label = val;
      item.name = toName(val);
      updatePreview();
      updateJSON();
    }));

    const helperDiv = document.createElement('div');
    helperDiv.style.cssText = 'font-size: 0.85rem; color: #666; margin-top: -0.5rem; margin-bottom: 1rem; font-style: italic;';
    helperDiv.textContent = 'Label that appears above the date picker';
    div.appendChild(helperDiv);

    div.appendChild(createCheckboxGroup('Required Field:', item.required, val => {
      item.required = val;
      updatePreview();
      updateJSON();
    }));

  // ‚úÖ Then check selection types
  } else if (['single-choice', 'multiple-choice', 'dropdown', 'optin'].includes(item.type)) {
    div.appendChild(createFormGroup('Field Label:', item.label, val => {
      item.label = val;
      item.name = toName(val);
      updatePreview();
      updateJSON();
    }));

    const helperDiv = document.createElement('div');
    helperDiv.style.cssText = 'font-size: 0.85rem; color: #666; margin-top: -0.5rem; margin-bottom: 1rem; font-style: italic;';
    let helperText = 'Label that appears for this selection field';
    if (item.type === 'single-choice') helperText = 'Question text for radio button selection';
    else if (item.type === 'multiple-choice') helperText = 'Question text for checkbox selection';
    else if (item.type === 'dropdown') helperText = 'Label that appears above the dropdown';
    else if (item.type === 'optin') helperText = 'Text that appears next to the checkbox';
    helperDiv.textContent = helperText;
    div.appendChild(helperDiv);

    div.appendChild(createCheckboxGroup('Required Field:', item.required, val => {
      item.required = val;
      updatePreview();
      updateJSON();
    }));

    if (item.type !== 'optin') {
      const optionsContainer = document.createElement('div');
      optionsContainer.className = 'options-container';

      const optionsLabel = document.createElement('div');
      optionsLabel.innerHTML = '<strong>Options:</strong>';
      optionsContainer.appendChild(optionsLabel);

      item.options.forEach((opt, idx) => {
        const optDiv = document.createElement('div');
        optDiv.className = 'option-item';

        const optInput = document.createElement('input');
        optInput.type = 'text';
        optInput.className = 'form-control';
        optInput.value = opt;
        optInput.placeholder = `Option ${idx + 1}`;
        optInput.oninput = (e) => {
          item.options[idx] = e.target.value;
          updatePreview();
          updateJSON();
        };

        const delOptBtn = document.createElement('button');
        delOptBtn.textContent = '‚ùå';
        delOptBtn.className = 'btn btn-danger';
        delOptBtn.onclick = () => {
          item.options.splice(idx, 1);
          renderContentList();
          updatePreview();
          updateJSON();
        };

        optDiv.appendChild(optInput);
        optDiv.appendChild(delOptBtn);
        optionsContainer.appendChild(optDiv);
      });

      const addOptBtn = document.createElement('button');
      addOptBtn.textContent = '‚ûï Add Option';
      addOptBtn.className = 'btn btn-success';
      addOptBtn.onclick = () => {
        item.options.push(`Option ${item.options.length + 1}`);
        renderContentList();
        updatePreview();
        updateJSON();
      };
      optionsContainer.appendChild(addOptBtn);

      div.appendChild(optionsContainer);
    }
  }

  console.log('Rendering:', item.type, item);
  return div;
}


function createFormGroup(labelText, value, onChange) {
  const group = document.createElement('div');
  group.className = 'form-group';

  const label = document.createElement('label');
  label.textContent = labelText;
  group.appendChild(label);

  const input = document.createElement('input');
  input.type = 'text';
  input.className = 'form-control';
  input.value = value || '';
  input.oninput = e => onChange(e.target.value);
  group.appendChild(input);

  return group;
}

function createCheckboxGroup(labelText, checked, onChange) {
  const group = document.createElement('div');
  group.className = 'checkbox-group';

  const input = document.createElement('input');
  input.type = 'checkbox';
  input.checked = checked;
  input.onchange = e => onChange(e.target.checked);

  const label = document.createElement('label');
  label.textContent = labelText;

  group.appendChild(input);
  group.appendChild(label);
  return group;
}

function createSelectGroup(labelText, options, selectedValue, onChange) {
  const group = document.createElement('div');
  group.className = 'form-group';

  const label = document.createElement('label');
  label.textContent = labelText;
  group.appendChild(label);

  const select = document.createElement('select');
  select.className = 'form-control';
  for (const opt of options) {
    const option = document.createElement('option');
    option.value = opt;
    option.textContent = opt;
    if (opt === selectedValue) option.selected = true;
    select.appendChild(option);
  }
  select.onchange = e => onChange(e.target.value);
  group.appendChild(select);

  return group;
}

function toName(label) {
  return label.trim().toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
}

function updatePreview() {
  const preview = document.getElementById('previewContent');
  const currentScreen = getCurrentScreen();
  const contentItems = currentScreen.contentItems;
  
  if (!contentItems.length) {
    preview.innerHTML = `
      <div class="empty-preview">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
        <h3>Your form will appear here</h3>
        <p>Add content elements to see a live preview</p>
      </div>
    `;
    return;
  }

  const title = document.getElementById('titleInput').value.trim();
  let html = '';
  
  if (title) {
    html += `<h1 style="text-align: center; margin-bottom: 2rem; color: var(--gray-800);">${escapeHtml(title)}</h1>`;
  }

  for (const item of contentItems) {
    if (item.type.startsWith('Text')) {
      html += renderTextPreview(item);
    } else if (item.type === 'TextInput' || item.type === 'TextArea' || item.type === 'DatePicker') {
      html += renderAnswerPreview(item);
    } else if (['single-choice', 'multiple-choice', 'dropdown', 'optin'].includes(item.type)) {
      html += renderSelectionPreview(item);
    }
  }
  preview.innerHTML = html;
}

function renderTextPreview(item) {
  let tag = 'p', style = '';
  switch(item.type) {
    case 'TextHeading': 
      tag = 'h1'; 
      style = 'font-weight: 700; font-size: 2rem; margin: 1.5rem 0; color: var(--gray-800);'; 
      break;
    case 'TextSubheading': 
      tag = 'h3'; 
      style = 'font-weight: 600; font-size: 1.3rem; margin: 1rem 0; color: var(--gray-700);'; 
      break;
    case 'TextBody': 
      tag = 'p'; 
      style = 'font-size: 1rem; margin: 0.8rem 0; color: var(--gray-600); line-height: 1.6;'; 
      break;
    case 'TextCaption': 
      tag = 'small'; 
      style = 'font-size: 0.8rem; color: var(--gray-500); display: block; margin: 0.5rem 0;'; 
      break;
    default: tag = 'p';
  }
  const text = escapeHtml(item.text) || `[${getFieldTypeLabel(item.type)}]`;
  return `<${tag} style="${style}">${text}</${tag}>`;
}

function renderAnswerPreview(item) {
  const label = escapeHtml(item.label || getFieldTypeLabel(item.type));
  console.log(item)
 
  const required = item.required ? 'required' : '';
  const name = escapeHtml(item.name);
  console.log(name)
  let inputHTML = '';

  if (item.type === 'TextInput') {
 
    inputHTML = `<input type="${item.inputType || 'text'}" name="${escapeHtml(item.name)}" placeholder="Enter ${label.toLowerCase()}" ${required} disabled style="width: 100%; padding: 0.8rem; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 1rem; background: var(--gray-50);">`;
  } else if (item.type === 'textrea') {
    inputHTML = `<textarea name="${escapeHtml(item.name)}" placeholder="Enter ${label.toLowerCase()}" ${required} disabled style="width: 100%; padding: 0.8rem; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 1rem; background: var(--gray-50); min-height: 100px; resize: vertical;"></textarea>`;
  } else if (item.type === 'DatePicker') {
  
    inputHTML = `<input type="date" name="${escapeHtml(item.name)}" ${required} disabled style="width: 100%; padding: 0.8rem; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 1rem; background: var(--gray-50);">`;
  }

  return `<div class="preview-form-group" style="margin-bottom: 1.5rem;">
    <label style="display: block; font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem; font-size: 1rem;">${label}${item.required ? ' <span style="color: #dc3545;">*</span>' : ''}</label>
    ${inputHTML}
  </div>`;
}

function renderSelectionPreview(item) {
  const label = escapeHtml(item.label || getFieldTypeLabel(item.type));
  const required = item.required ? 'required' : '';
  const name = escapeHtml(item.name);
 

  if (item.type === 'optin') {
    return `<div class="preview-form-group" style="margin-bottom: 1.5rem;">
      <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 600; color: var(--gray-700); font-size: 1rem;">
        <input type="checkbox" name="${name}" ${required} disabled style="width: 18px; height: 18px; accent-color: #0066cc;">
        ${label}${item.required ? ' <span style="color: #dc3545;">*</span>' : ''}
      </label>
    </div>`;
  }

  if (item.type === 'single-choice') {
    let radios = '';
    item.options.forEach((opt, idx) => {
      radios += `<label class="radio-group" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-bottom: 0.5rem; font-weight: normal; color: var(--gray-600);">
        <input type="radio" name="${name}" value="${escapeHtml(opt)}" disabled style="width: 18px; height: 18px; accent-color: #0066cc;">
        ${escapeHtml(opt)}
      </label>`;
    });
    return `<fieldset class="preview-form-group" style="border: 2px solid var(--gray-200); border-radius: 8px; padding: 1rem; background: var(--gray-50); margin-bottom: 1.5rem;">
      <legend style="font-weight: 600; color: var(--gray-700); padding: 0 0.5rem; font-size: 1rem;">${label}${item.required ? ' <span style="color: #dc3545;">*</span>' : ''}</legend>
      ${radios}
    </fieldset>`;
  }

  if (item.type === 'multiple-choice') {
    let checks = '';
    item.options.forEach((opt, idx) => {
      checks += `<label class="checkbox-group-preview" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-bottom: 0.5rem; font-weight: normal; color: var(--gray-600);">
        <input type="checkbox" name="${name}" value="${escapeHtml(opt)}" disabled style="width: 18px; height: 18px; accent-color: #0066cc;">
        ${escapeHtml(opt)}
      </label>`;
    });
    return `<fieldset class="preview-form-group" style="border: 2px solid var(--gray-200); border-radius: 8px; padding: 1rem; background: var(--gray-50); margin-bottom: 1.5rem;">
      <legend style="font-weight: 600; color: var(--gray-700); padding: 0 0.5rem; font-size: 1rem;">${label}${item.required ? ' <span style="color: #dc3545;">*</span>' : ''}</legend>
      ${checks}
    </fieldset>`;
  }

  if (item.type === 'dropdown') {
    let optionsHTML = `<option value="">--Select ${label}--</option>`;
    item.options.forEach(opt => {
      optionsHTML += `<option value="${escapeHtml(opt)}">${escapeHtml(opt)}</option>`;
    });
    return `<div class="preview-form-group" style="margin-bottom: 1.5rem;">
      <label style="display: block; font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem; font-size: 1rem;">${label}${item.required ? ' <span style="color: #dc3545;">*</span>' : ''}</label>
      <select name="${name}" ${required} disabled style="width: 100%; padding: 0.8rem; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 1rem; background: var(--gray-50);">${optionsHTML}</select>
    </div>`;
  }

  return '';
}

function escapeHtml(text) {
  if (!text) return '';
  return text.replace(/[&<>"']/g, function(m) {
    return {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    }[m];
  });
}

// Helper function to create URL-safe ID from title
function titleToId(title) {
  return title.trim()
    .toLowerCase()
    .replace(/\s+/g, '_')
    .replace(/[^a-z0-9_]/g, '');
}

function updateJSON() {
  const jsonData = {
    version: "7.0",
    screens: []
  };

  const usedIds = new Set();

  screens.forEach((screen, screenIndex) => {
    // Use title input if on current screen
    const title = screenIndex === currentScreenIndex
      ? (document.getElementById('titleInput').value || screen.title)
      : screen.title;

    // Convert title to URL-safe ID
    let screenId = titleToId(title) || `screen_${screenIndex}`;

    // Ensure uniqueness of screen ID
    let uniqueId = screenId;
    let count = 1;
    while (usedIds.has(uniqueId)) {
      uniqueId = `${screenId}_${count++}`;
    }
    screenId = uniqueId;
    usedIds.add(screenId);

    const textItems = screen.contentItems.filter(item =>
      ['TextHeading', 'TextSubheading', 'TextBody', 'TextCaption'].includes(item.type)
    );

    const formItems = screen.contentItems.filter(item =>
      ['TextInput', 'TextArea', 'DatePicker'].includes(item.type) ||
      ['single-choice', 'multiple-choice', 'dropdown', 'optin'].includes(item.type)
    );

    const children = [];
    const payload = {};
    const dataObject = {};
    const formChildren = [];

    // Add text fields
    textItems.forEach(item => {
      if (item.text) {
        formChildren.push({
          type: item.type,
          text: item.text
        });
      }
    });

    // Add form fields and collect payload/data
    formItems.forEach((item, index) => {
      const fieldName = item.name || `field_${index}`;
      let fieldType;

      if (['TextInput', 'TextArea', 'DatePicker'].includes(item.type)) {
        const fieldObj = {
          type: item.type,
          label: item.label || `Label ${index + 1}`,
          name: fieldName,
          required: !!item.required
        };

        // Add input-type if TextInput and exists (changed from inputType)
        if (item.type === 'TextInput' && item.inputType) {
          fieldObj['input-type'] = item.inputType;
        }

        formChildren.push(fieldObj);
      } else {
        if (item.type === 'single-choice') fieldType = 'RadioButtonsGroup';
        if (item.type === 'multiple-choice') fieldType = 'CheckboxGroup';
        if (item.type === 'dropdown') fieldType = 'Dropdown';
        if (item.type === 'optin') fieldType = 'OptIn';

        const field = {
          type: fieldType,
          label: item.label || `Label ${index + 1}`,
          name: fieldName,
          required: !!item.required
        };

        if (item.options?.length && fieldType !== 'OptIn') {
          field['data-source'] = item.options.map((opt, i) => ({
            id: `${i}_${opt.replace(/\s+/g, '_')}`,
            title: opt
          }));
        }

        formChildren.push(field);
      }

      const key = `${screenId}_${fieldName}_${index}`;
      payload[key] = `\${form.${fieldName}}`;

      // Add previous screen data if not first
      if (screenIndex !== 0) {
        const prevKeys = Object.keys(jsonData.screens[0]?.data || {});
        prevKeys.forEach(prevKey => {
          payload[prevKey] = `\${data.${prevKey}}`;
        });
      }

      dataObject[key] = {
        type: "string",
        __example__: "Example"
      };
    });

    const isLastScreen = screenIndex === screens.length - 1;

    // Add footer with navigation or complete
    formChildren.push({
      type: "Footer",
      label: isLastScreen ? "Done" : "Continue",
      "on-click-action": isLastScreen
        ? {
            name: "complete",
            payload: payload
          }
        : {
            name: "navigate",
            next: {
              type: "screen",
              name: titleToId(screens[screenIndex + 1]?.title) || `screen_${screenIndex + 1}`
            },
            payload: payload
          }
    });

    children.push({
      type: "Form",
      name: "form",
      children: formChildren
    });

    const screenObj = {
      id: screenId,
      title: title,
      data: screenIndex === 0 ? {} : { ...jsonData.screens[0]?.data, ...dataObject },
      layout: {
        type: "SingleColumnLayout",
        children: children
      }
    };

    if (isLastScreen) {
      screenObj.terminal = true;
      screenObj.success = true;
    }

    jsonData.screens.push(screenObj);
  });

  document.getElementById('jsonOutput').textContent = JSON.stringify(jsonData, null, 2);
}
function copyJSON() {
  const jsonText = document.getElementById('jsonOutput').textContent;
  navigator.clipboard.writeText(jsonText).then(() => {
    // Create a toast notification
    const toast = document.createElement('div');
    toast.innerHTML = '‚úÖ JSON copied to clipboard!';
    toast.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    `;
    document.body.appendChild(toast);
    setTimeout(() => {
      toast.remove();
    }, 3000);
  }).catch(() => {
    alert('Failed to copy JSON to clipboard.');
  });
}

// Update screen title when input changes
document.getElementById('titleInput').addEventListener('input', (e) => {
  const currentScreen = getCurrentScreen();
  currentScreen.title = e.target.value || `Screen ${currentScreenIndex + 1}`;
  renderScreenTabs();
  updatePreview();
  updateJSON();
});

// Initialize with first screen
renderScreenTabs();
renderContentList();
updatePreview();
updateJSON();
</script>

<script>
      document.addEventListener('DOMContentLoaded', function () {
          document.querySelectorAll('.move-to-templates-btn').forEach(btn => {
              btn.addEventListener('click', function() {
                  const flowId = this.dataset.flowId;
                  const flowName = this.dataset.flowName;
      
                  // Populate the form fields with the flow data
                  document.getElementById('flow_id').value = flowId;
                  document.getElementById('template_name').value = flowName;
      
                  // Show the modal using Bootstrap's modal function
                  const moveToTemplatesModal = new bootstrap.Modal(document.getElementById('moveToTemplatesModal'));
                  moveToTemplatesModal.show();
              });
          });
      
          // Handle form submission
          document.getElementById('createTemplateForm').addEventListener('submit', function(e) {
              e.preventDefault();
              
              const formData = new FormData(this);
              
              fetch('{% url "create_template_from_flow" %}', {
                  method: 'POST',
                  body: formData
              })
              .then(response => response.json())
              .then(data => {
                  if (data.success) {
                      // Template creation successful, show a success message
                      alert('Template created successfully!');
      
                      // Hide the modal after submission
                      const moveToTemplatesModal = bootstrap.Modal.getInstance(document.getElementById('moveToTemplatesModal'));
                      moveToTemplatesModal.hide();
      
                      // Reload the page after the modal is closed
                      setTimeout(() => {
                          location.reload();
                      }, 500); // You can adjust the delay time if needed
                  } else {
                      // Template creation failed, show an error message
                      alert(data.error);
                  }
              })
              .catch(() => {
                  // Handle AJAX error
                  alert('Done');
              });
          });
      });
      </script>  
      
      <script>
          document.addEventListener('DOMContentLoaded', function() {
              function handleResponse(response) {
                  if (!response.ok) {
                      return response.text().then(text => {
                          throw new Error(text);
                      });
                  }
                  return response.json();
              }
          
              document.querySelectorAll('.publish-btn').forEach(button => {
                  button.addEventListener('click', function() {
                      const flowId = this.getAttribute('data-flow-id');
                      const flowName = this.getAttribute('data-flow-name');
                      
                      if (confirm(`Are you sure you want to publish "${flowName}"?`)) {
                          fetch(`/flows/publish/${flowId}/`, {
                              method: 'POST',
                              headers: {
                                  'Content-Type': 'application/json',
                                  'X-Requested-With': 'XMLHttpRequest'
                              },
                          })
                          .then(handleResponse)
                          .then(data => {
                              if (data.success) {
                                  alert('Success: ' + data.message);
                                  location.reload();
                              } else {
                                  alert('Error: ' + data.message);
                              }
                          })
                          .catch(error => {
                              console.error('Error:', error);
                              alert('Error occurred. Please check console for details.');
                          });
                      }
                  });
              });
          
          
              document.querySelectorAll('.deprecate-btn').forEach(button => {
                  button.addEventListener('click', function() {
                      const flowId = this.getAttribute('data-flow-id');
                      const flowName = this.getAttribute('data-flow-name');
                      
                      if (confirm(`Are you sure you want to deprecate "${flowName}"?`)) {
                          fetch(`/flows/deprecate/${flowId}/`, {
                              method: 'POST',
                              headers: {
                                  'Content-Type': 'application/json',
                                  'X-Requested-With': 'XMLHttpRequest'
                              },
                          })
                          .then(handleResponse)
                          .then(data => {
                              if (data.success) {
                                  alert('Success: ' + data.message);
                                  location.reload();
                              } else {
                                  alert('Error: ' + data.message);
                              }
                          })
                          .catch(error => {
                              console.error('Error:', error);
                              alert('Error occurred. Please check console for details.');
                          });
                      }
                  });
              });
          
          
              document.querySelectorAll('.preview-btn').forEach(button => {
                  button.addEventListener('click', function() {
                      const flowId = this.getAttribute('data-flow-id');
          
                      fetch(`/get-preview-url/${flowId}/`)  // 
                          .then(response => response.json())
                          .then(data => {
                              if (data.preview_url) {
                                  window.location.href = data.preview_url;
                              } else {
                                  alert('Failed to get preview URL');
                              }
                          })
                          .catch(error => {
                              console.error('Error fetching preview URL:', error);
                              alert('Error fetching preview URL');
                          });
                  });
              });
  
              document.querySelectorAll('.delete-btn').forEach(button => {
                  button.addEventListener('click', function() {
                      const flowId = this.getAttribute('data-flow-id');
                      const flowName = this.getAttribute('data-flow-name');
                      
                      if (confirm(`Are you sure you want to delete "${flowName}"?`)) {
                          fetch(`/flows/delete/${flowId}/`, {
                              method: 'POST',
                              headers: {
                                  'Content-Type': 'application/json',
                                  'X-Requested-With': 'XMLHttpRequest'
                              },
                          })
                          .then(handleResponse)
                          .then(data => {
                              if (data.success) {
                                  alert('Success: ' + data.message);
                                  location.reload();
                              } else {
                                  alert('Error: ' + data.message);
                              }
                          })
                          .catch(error => {
                              console.error('Error:', error);
                              alert('Error occurred. Please check console for details.');
                          });
                      }
                  });
              });
          });
          </script>
{% endblock %}